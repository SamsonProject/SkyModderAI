# =============================================================================
# Pytest Configuration for SkyModderAI
# =============================================================================
# Professional-grade test configuration with coverage enforcement,
# parallel execution, and comprehensive reporting.
# =============================================================================

[tool.pytest.ini_options]
# Test discovery
testpaths = ["tests"]
python_files = ["test_*.py"]
python_classes = ["Test*"]
python_functions = ["test_*"]

# Test execution
addopts = """
    -v
    --tb=short
    --strict-markers
    --cov=.
    --cov-report=term-missing
    --cov-report=html:htmlcov
    --cov-report=xml:coverage.xml
    --cov-fail-under=80
    --maxfail=5
    --ignore=tests/test_openclaw.py
"""

# Markers
markers = [
    "slow: marks tests as slow (deselect with '-m \"not slow\"')",
    "integration: marks tests as integration tests",
    "e2e: marks tests as end-to-end tests",
    "requires_data: marks tests that require LOOT data files",
    "requires_db: marks tests that require database",
    "requires_api: marks tests that require API access",
    "openclaw: marks OpenCLAW-related tests",
    "security: marks security-related tests",
]

# Filter warnings
filterwarnings = [
    "ignore::DeprecationWarning",
    "ignore::PendingDeprecationWarning",
    "ignore::UserWarning",
]

# Logging
log_cli = true
log_cli_level = "INFO"
log_cli_format = "%(asctime)s [%(levelname)8s] %(message)s (%(filename)s:%(lineno)s)"
log_cli_date_format = "%Y-%m-%d %H:%M:%S"

# Coverage paths
[tool.coverage.run]
branch = true
source = [
    "blueprints",
    "services",
    "repositories",
    "exceptions",
    "security_utils",
    "logging_utils",
    "conflict_detector",
    "search_engine",
    "knowledge_index",
    "mod_recommendations",
    "mod_warnings",
    "system_impact",
    "list_builder",
    "openclaw_engine",
]
omit = [
    "*/tests/*",
    "*/__pycache__/*",
    "*/venv/*",
    "*/.venv/*",
    "*/migrations/*",
    "*/dev/*",
    "app.py",  # Legacy monolith - exclude from coverage
    "config.py",
]

[tool.coverage.report]
exclude_lines = [
    "pragma: no cover",
    "def __repr__",
    "raise AssertionError",
    "raise NotImplementedError",
    "if __name__ == .__main__.:",
    "if TYPE_CHECKING:",
    "@abstractmethod",
    "if not STRIPE_AVAILABLE:",
    "if not OPENAI_AVAILABLE:",
]
precision = 2
show_missing = true
skip_covered = false
fail_under = 80

[tool.coverage.html]
directory = "htmlcov"
title = "SkyModderAI Coverage Report"

[tool.coverage.xml]
output = "coverage.xml"

# =============================================================================
# Mypy Configuration (Type Checking)
# =============================================================================

[tool.mypy]
python_version = "3.9"
warn_return_any = true
warn_unused_configs = true
disallow_untyped_defs = true
disallow_incomplete_defs = true
check_untyped_defs = true
no_implicit_optional = true
warn_redundant_casts = true
warn_unused_ignores = true
warn_no_return = true
strict_equality = true
strict_optional = true

# Ignore missing imports for third-party libraries without stubs
[[tool.mypy.overrides]]
module = [
    "flask_compress.*",
    "duckduckgo_search.*",
    "stripe.*",
]
ignore_missing_imports = true

# =============================================================================
# Black Configuration (Code Formatting)
# =============================================================================

[tool.black]
line-length = 100
target-version = ['py39', 'py310', 'py311', 'py312']
include = '\.pyi?$'
exclude = '''
/(
    \.git
  | \.hg
  | \.mypy_cache
  | \.tox
  | \.venv
  | venv
  | _build
  | buck-out
  | build
  | dist
  | migrations
)/
'''

# =============================================================================
# Ruff Configuration (Linting)
# =============================================================================

[tool.ruff]
line-length = 100
target-version = "py39"

[tool.ruff.lint]
select = [
    "E",   # pycodestyle errors
    "W",   # pycodestyle warnings
    "F",   # Pyflakes
    "I",   # isort
    "B",   # flake8-bugbear
    "C4",  # flake8-comprehensions
    "UP",  # pyupgrade
    "ARG", # flake8-unused-arguments
]
ignore = [
    "E501",  # Line too long (handled by black)
    "B008",  # Do not perform function calls in argument defaults
    "ARG001", # Unused function argument (common in Flask)
    "ARG002", # Unused method argument
    # Type annotation style issues - allow both old and new syntax
    "UP045", # Use `X | None` for type annotations (allow Optional[])
    "UP006", # Use `list` instead of `List` (allow typing imports)
    "UP007", # Use `X | Y` instead of Union[] (allow Union[])
    "UP035", # `typing.X` is deprecated (allow typing imports for compatibility)
    # Other acceptable issues
    "B004",  # Use of hasattr (acceptable pattern in our codebase)
    "B005",  # Use of .strip() with multi-character strings (acceptable in our context)
    "B007",  # Unused loop variable (common pattern when we only need values)
    "B904",  # Raise without from (acceptable for simple error re-raising)
    "E402",  # Module level import not at top (necessary for circular imports)
    "F811",  # Redefinition of unused (acceptable for validation functions)
    "F841",  # Unused variable (sometimes we assign for future use or clarity)
    "E712",  # Equality comparison to False (SQLAlchemy pattern)
    "C401",  # Unnecessary generator (readability preference)
    "C416",  # Unnecessary dict comprehension (readability preference)
    "W293",  # Blank line with whitespace (migration files have this)
    "F401",  # Unused imports (sometimes needed for runtime)
]

[tool.ruff.lint.isort]
known-first-party = [
    "blueprints",
    "services",
    "repositories",
    "exceptions",
    "security_utils",
    "logging_utils",
    "conflict_detector",
    "search_engine",
    "knowledge_index",
]

[tool.ruff.lint.per-file-ignores]
"__init__.py" = ["F401"]  # Unused imports in __init__ files
"tests/*" = ["ARG", "B011"]  # Test files have different requirements
# Allow undefined names in files that have conditional imports or forward references
"cache_service.py" = ["F821"]  # Has dynamic variable access
"weekly_report.py" = ["F821"]  # Has SQLAlchemy model references
"repositories/*" = ["F821"]  # Has sqlite3 runtime imports
"blueprints/*" = ["F821"]  # Has Flask runtime imports

# =============================================================================
# Pre-commit Configuration
# =============================================================================

[tool.pre-commit]
repos = [
    { repo = "https://github.com/pre-commit/pre-commit-hooks", rev = "v4.5.0", hooks = [
        { id = "trailing-whitespace" },
        { id = "end-of-file-fixer" },
        { id = "check-yaml" },
        { id = "check-json" },
        { id = "check-added-large-files" },
        { id = "detect-private-key" },
    ] },
    { repo = "https://github.com/psf/black", rev = "24.1.0", hooks = [
        { id = "black" }
    ] },
    { repo = "https://github.com/astral-sh/ruff-pre-commit", rev = "v0.1.14", hooks = [
        { id = "ruff", args = ["--fix"] }
    ] },
    { repo = "https://github.com/pre-commit/mirrors-mypy", rev = "v1.8.0", hooks = [
        { id = "mypy", additional_dependencies = [
            "types-requests",
            "types-PyYAML",
            "types-stripe",
        ] }
    ] },
]
