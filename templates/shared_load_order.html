{% extends "base.html" %}

{% block title %}Shared Load Order - SkyModderAI{% endblock %}

{% block head %}
{{ super() }}
<style>
    .shared-load-order {
        max-width: 1000px;
        margin: 2rem auto;
        padding: 0 1rem;
    }

    .share-header {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 1.5rem;
        margin-bottom: 2rem;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .share-title {
        margin-top: 0;
        color: #2c3e50;
        font-size: 1.8rem;
    }

    .share-meta {
        display: flex;
        flex-wrap: wrap;
        gap: 1.5rem;
        margin: 1rem 0;
        color: #6c757d;
        font-size: 0.9rem;
    }

    .share-meta-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .share-meta-item i {
        font-size: 1.1em;
    }

    .share-notes {
        background: #f1f8ff;
        border-left: 4px solid #4a90e2;
        padding: 1rem;
        margin: 1.5rem 0;
        border-radius: 0 4px 4px 0;
    }

    .mod-list {
        background: white;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        overflow: hidden;
    }

    .mod-list-header {
        background: #f1f5f9;
        padding: 1rem 1.5rem;
        border-bottom: 1px solid #e2e8f0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .mod-list-title {
        margin: 0;
        font-size: 1.2rem;
        color: #2d3748;
    }

    .mod-count {
        background: #4a90e2;
        color: white;
        border-radius: 12px;
        padding: 0.25rem 0.75rem;
        font-size: 0.85rem;
        font-weight: 600;
    }

    .mod-item {
        padding: 1rem 1.5rem;
        border-bottom: 1px solid #edf2f7;
        display: flex;
        align-items: center;
        gap: 1rem;
        transition: background-color 0.2s;
    }

    .mod-item:last-child {
        border-bottom: none;
    }

    .mod-item:hover {
        background-color: #f8fafc;
    }

    .mod-icon {
        width: 40px;
        height: 40px;
        background: #e2e8f0;
        border-radius: 6px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #64748b;
        flex-shrink: 0;
    }

    .mod-details {
        flex-grow: 1;
        min-width: 0;
    }

    .mod-name {
        font-weight: 600;
        color: #1a202c;
        margin: 0 0 0.25rem 0;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .mod-version {
        font-size: 0.85rem;
        color: #64748b;
        margin: 0;
    }

    .analysis-section {
        margin-top: 2.5rem;
    }

    .analysis-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
    }

    .analysis-title {
        margin: 0;
        color: #2d3748;
        font-size: 1.5rem;
    }

    .analysis-results {
        background: white;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        overflow: hidden;
    }

    .alert {
        padding: 1rem;
        margin-bottom: 1rem;
        border-radius: 4px;
        display: flex;
        align-items: flex-start;
        gap: 0.75rem;
    }

    .alert-warning {
        background-color: #fff3cd;
        border-left: 4px solid #ffc107;
    }

    .alert-danger {
        background-color: #f8d7da;
        border-left: 4px solid #dc3545;
    }

    .alert-info {
        background-color: #e7f5ff;
        border-left: 4px solid #4dabf7;
    }

    .alert-icon {
        font-size: 1.25rem;
        line-height: 1;
        margin-top: 0.1rem;
    }

    .alert-content {
        flex-grow: 1;
    }

    .alert-title {
        margin: 0 0 0.25rem 0;
        font-weight: 600;
        color: #1a202c;
    }

    .alert-message {
        margin: 0;
        color: #2d3748;
        font-size: 0.95rem;
        line-height: 1.5;
    }

    .footer-actions {
        margin-top: 2rem;
        padding-top: 1.5rem;
        border-top: 1px solid #e2e8f0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .btn {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        border-radius: 4px;
        font-weight: 500;
        text-decoration: none;
        transition: all 0.2s;
        cursor: pointer;
        border: 1px solid transparent;
    }

    .btn-primary {
        background-color: #4a90e2;
        color: white;
    }

    .btn-primary:hover {
        background-color: #3a7bc8;
    }

    .btn-outline {
        background: white;
        border-color: #cbd5e0;
        color: #4a5568;
    }

    .btn-outline:hover {
        background-color: #f7fafc;
        border-color: #a0aec0;
    }

    .btn-icon {
        font-size: 1.1em;
    }

    .empty-state {
        text-align: center;
        padding: 3rem 1.5rem;
        color: #64748b;
    }

    .empty-state-icon {
        font-size: 3rem;
        margin-bottom: 1rem;
        color: #cbd5e0;
    }

    .empty-state-title {
        margin: 0 0 0.5rem 0;
        font-size: 1.25rem;
        font-weight: 600;
        color: #2d3748;
    }

    .empty-state-description {
        margin: 0 0 1.5rem 0;
        max-width: 400px;
        margin-left: auto;
        margin-right: auto;
    }

    @media (max-width: 768px) {
        .share-meta {
            flex-direction: column;
            gap: 0.75rem;
        }

        .mod-item {
            padding: 0.75rem 1rem;
        }

        .mod-icon {
            width: 36px;
            height: 36px;
        }

        .footer-actions {
            flex-direction: column;
            gap: 1rem;
            align-items: stretch;
        }

        .btn {
            justify-content: center;
            padding: 0.625rem 1rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="shared-load-order">
    <div id="loading" class="empty-state">
        <div class="empty-state-icon">
            <i class="fas fa-spinner fa-spin"></i>
        </div>
        <h3 class="empty-state-title">Loading shared load order...</h3>
        <p class="empty-state-description">Please wait while we load the shared load order.</p>
    </div>

    <div id="content" style="display: none;">
        <div class="share-header">
            <h1 id="share-title" class="share-title">Shared Load Order</h1>

            <div class="share-meta">
                <div class="share-meta-item">
                    <i class="fas fa-gamepad"></i>
                    <span id="game-name">Game</span>
                </div>
                <div class="share-meta-item">
                    <i class="fas fa-calendar-alt"></i>
                    <span id="share-date">Shared on</span>
                </div>
                <div class="share-meta-item">
                    <i class="fas fa-eye"></i>
                    <span id="view-count">0 views</span>
                </div>
                <div class="share-meta-item">
                    <i class="fas fa-user"></i>
                    <span id="shared-by">Shared by Anonymous</span>
                </div>
            </div>

            <div id="share-notes" class="share-notes" style="display: none;">
                <p id="notes-content"></p>
            </div>
        </div>

        <div class="mod-list">
            <div class="mod-list-header">
                <h2 class="mod-list-title">Mod List</h2>
                <span id="mod-count" class="mod-count">0 mods</span>
            </div>

            <div id="mod-list-container">
                <!-- Mod items will be inserted here by JavaScript -->
                <div class="empty-state">
                    <div class="empty-state-icon">
                        <i class="fas fa-box-open"></i>
                    </div>
                    <h3 class="empty-state-title">No mods found</h3>
                    <p class="empty-state-description">This load order doesn't contain any mods.</p>
                </div>
            </div>
        </div>

        <div class="analysis-section">
            <div class="analysis-header">
                <h2 class="analysis-title">Compatibility Analysis</h2>
            </div>

            <div id="analysis-results" class="analysis-results">
                <!-- Analysis results will be inserted here by JavaScript -->
                <div class="empty-state">
                    <div class="empty-state-icon">
                        <i class="fas fa-chart-bar"></i>
                    </div>
                    <h3 class="empty-state-title">No analysis results</h3>
                    <p class="empty-state-description">This load order doesn't have any analysis results.</p>
                </div>
            </div>
        </div>

        <div class="footer-actions">
            <a href="/" class="btn btn-outline">
                <i class="fas fa-arrow-left btn-icon"></i>
                Back to SkyModderAI
            </a>
            <button id="copy-link" class="btn btn-primary">
                <i class="far fa-copy btn-icon"></i>
                Copy Share Link
            </button>
        </div>
    </div>

    <div id="error" class="empty-state" style="display: none;">
        <div class="empty-state-icon">
            <i class="fas fa-exclamation-triangle"></i>
        </div>
        <h3 class="empty-state-title" id="error-title">Error Loading Shared Load Order</h3>
        <p class="empty-state-description" id="error-message">The shared load order could not be found or has expired.</p>
        <a href="/" class="btn btn-primary">
            <i class="fas fa-home btn-icon"></i>
            Return to Home
        </a>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const shareId = '{{ share_id }}';
    const loadingEl = document.getElementById('loading');
    const contentEl = document.getElementById('content');
    const errorEl = document.getElementById('error');

    // Format date
    function formatDate(dateString) {
        if (!dateString) return 'Unknown date';
        const options = {
            year: 'numeric',
            month: 'long',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit',
            timeZoneName: 'short'
        };
        return new Date(dateString).toLocaleDateString(undefined, options);
    }

    // Format game name
    function formatGameName(gameId) {
        const gameNames = {
            'skyrimse': 'Skyrim Special Edition',
            'fallout4': 'Fallout 4',
            'skyrimvr': 'Skyrim VR',
            'fallout4vr': 'Fallout 4 VR',
            'enderal': 'Enderal: Forgotten Stories'
        };
        return gameNames[gameId] || gameId;
    }

    // Render mod list
    function renderModList(mods) {
        const container = document.getElementById('mod-list-container');

        if (!mods || mods.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">
                        <i class="fas fa-box-open"></i>
                    </div>
                    <h3 class="empty-state-title">No mods found</h3>
                    <p class="empty-state-description">This load order doesn't contain any mods.</p>
                </div>
            `;
            return;
        }

        container.innerHTML = mods.map((mod, index) => {
            const modName = mod.name || `Mod ${index + 1}`;
            const modVersion = mod.version ? `<p class="mod-version">${mod.version}</p>` : '';

            return `
                <div class="mod-item">
                    <div class="mod-icon">
                        <i class="fas fa-puzzle-piece"></i>
                    </div>
                    <div class="mod-details">
                        <h3 class="mod-name" title="${modName}">${modName}</h3>
                        ${modVersion}
                    </div>
                </div>
            `;
        }).join('');
    }

    // Render analysis results
    function renderAnalysisResults(analysis) {
        const container = document.getElementById('analysis-results');

        if (!analysis || Object.keys(analysis).length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">
                        <i class="fas fa-chart-bar"></i>
                    </div>
                    <h3 class="empty-state-title">No analysis results</h3>
                    <p class="empty-state-description">This load order doesn't have any analysis results.</p>
                </div>
            `;
            return;
        }

        // Handle different types of analysis results
        let html = '';

        // Warnings
        if (analysis.warnings && analysis.warnings.length > 0) {
            analysis.warnings.forEach(warning => {
                html += `
                    <div class="alert alert-warning">
                        <div class="alert-icon">⚠️</div>
                        <div class="alert-content">
                            <h4 class="alert-title">Warning</h4>
                            <p class="alert-message">${warning}</p>
                        </div>
                    </div>
                `;
            });
        }

        // Errors
        if (analysis.errors && analysis.errors.length > 0) {
            analysis.errors.forEach(error => {
                html += `
                    <div class="alert alert-danger">
                        <div class="alert-icon">❌</div>
                        <div class="alert-content">
                            <h4 class="alert-title">Error</h4>
                            <p class="alert-message">${error}</p>
                        </div>
                    </div>
                `;
            });
        }

        // General info
        if (analysis.info && analysis.info.length > 0) {
            analysis.info.forEach(info => {
                html += `
                    <div class="alert alert-info">
                        <div class="alert-icon">ℹ️</div>
                        <div class="alert-content">
                            <h4 class="alert-title">Information</h4>
                            <p class="alert-message">${info}</p>
                        </div>
                    </div>
                `;
            });
        }

        // Compatibility issues
        if (analysis.compatibility_issues && analysis.compatibility_issues.length > 0) {
            analysis.compatibility_issues.forEach(issue => {
                html += `
                    <div class="alert alert-warning">
                        <div class="alert-icon">⚠️</div>
                        <div class="alert-content">
                            <h4 class="alert-title">Compatibility Issue</h4>
                            <p class="alert-message">
                                <strong>${issue.mod1}</strong> and <strong>${issue.mod2}</strong> may have compatibility issues:
                                ${issue.description || 'These mods modify the same files or game mechanics.'}
                            </p>
                        </div>
                    </div>
                `;
            });
        }

        // Performance impact
        if (analysis.performance_impact) {
            let impactLevel = '';
            let impactText = '';

            if (analysis.performance_impact.level === 'high') {
                impactLevel = 'High';
                impactText = 'This load order may significantly impact game performance.';
            } else if (analysis.performance_impact.level === 'medium') {
                impactLevel = 'Medium';
                impactText = 'This load order may have a moderate impact on game performance.';
            } else {
                impactLevel = 'Low';
                impactText = 'This load order should have minimal impact on game performance.';
            }

            html += `
                <div class="alert alert-info">
                    <div class="alert-icon">⚡</div>
                    <div class="alert-content">
                        <h4 class="alert-title">Performance Impact: ${impactLevel}</h4>
                        <p class="alert-message">${impactText}</p>
                        ${analysis.performance_impact.details ? `<p class="alert-message">${analysis.performance_impact.details}</p>` : ''}
                    </div>
                </div>
            `;
        }

        // If no alerts were added, show a message
        if (html === '') {
            html = `
                <div class="empty-state">
                    <div class="empty-state-icon">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <h3 class="empty-state-title">No Issues Found</h3>
                    <p class="empty-state-description">No compatibility issues or warnings were detected in this load order.</p>
                </div>
            `;
        }

        container.innerHTML = html;
    }

    // Copy share link to clipboard
    function setupCopyButton() {
        const copyButton = document.getElementById('copy-link');
        if (!copyButton) return;

        copyButton.addEventListener('click', function() {
            const url = window.location.href;

            navigator.clipboard.writeText(url).then(() => {
                const originalText = copyButton.innerHTML;
                copyButton.innerHTML = '<i class="fas fa-check btn-icon"></i> Link Copied!';

                setTimeout(() => {
                    copyButton.innerHTML = originalText;
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy URL: ', err);
                alert('Failed to copy link. Please try again.');
            });
        });
    }

    // Load shared load order data
    async function loadSharedLoadOrder() {
        try {
            const response = await fetch(`/api/load-order/share/${shareId}`);

            if (!response.ok) {
                throw new Error('Failed to load shared load order');
            }

            const data = await response.json();

            // Update page title
            document.title = `${data.title || 'Shared Load Order'} - SkyModderAI`;

            // Update header
            if (data.title) {
                document.getElementById('share-title').textContent = data.title;
            }

            // Update metadata
            document.getElementById('game-name').textContent = formatGameName(data.game);
            document.getElementById('share-date').textContent = `Shared on ${formatDate(data.created_at)}`;
            document.getElementById('view-count').textContent = `${data.view_count} view${data.view_count !== 1 ? 's' : ''}`;

            if (data.user_display) {
                document.getElementById('shared-by').textContent = `Shared by ${data.user_display}`;
            } else {
                document.getElementById('shared-by').textContent = 'Shared anonymously';
            }

            // Update notes if available
            if (data.notes) {
                document.getElementById('notes-content').textContent = data.notes;
                document.getElementById('share-notes').style.display = 'block';
            }

            // Update mod list
            document.getElementById('mod-count').textContent = `${data.mod_list.length} mod${data.mod_list.length !== 1 ? 's' : ''}`;
            renderModList(data.mod_list);

            // Update analysis results
            if (data.analysis_results) {
                renderAnalysisResults(data.analysis_results);
            }

            // Show content and hide loading state
            loadingEl.style.display = 'none';
            contentEl.style.display = 'block';

            // Setup copy button
            setupCopyButton();

        } catch (error) {
            console.error('Error loading shared load order:', error);

            // Update error message
            const errorTitle = document.getElementById('error-title');
            const errorMessage = document.getElementById('error-message');

            if (error.message.includes('404')) {
                errorTitle.textContent = 'Shared Load Order Not Found';
                errorMessage.textContent = 'The shared load order could not be found. It may have been deleted or the link may be incorrect.';
            } else if (error.message.includes('expired')) {
                errorTitle.textContent = 'Shared Load Order Expired';
                errorMessage.textContent = 'This shared load order has expired and is no longer available.';
            } else {
                errorTitle.textContent = 'Error Loading Shared Load Order';
                errorMessage.textContent = 'An error occurred while loading the shared load order. Please try again later.';
            }

            // Show error and hide loading state
            loadingEl.style.display = 'none';
            errorEl.style.display = 'block';
        }
    }

    // Initialize
    loadSharedLoadOrder();
});
</script>
{% endblock %}
